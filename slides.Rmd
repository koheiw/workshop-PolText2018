---
title: "Introduction to Text Analysis using Machine Learning"
author: "Kohei Watanabe (LSE, Waseda)"
date: "9 May 2018"
output: 
    ioslides_presentation:
        css: images/ioslides_styles.css
        logo: images/quanteda-logo.png
        widescreen: true
        toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	cache = TRUE
)
require(quanteda)
```

# Introduction

## What is Quanteda?

**quanteda** is an R package for quantitative text analysis developed by a team based at the LSE.

- After 5 years of development, we released version 1.0 at London R meeting in January
- Used by leading political scientists in North America, Europe and Asia
- It is a stand-alone tool, but can be used to develop packages (e.g. **politeness**, **preText**, **phrasemachine**, **tidytext**, **stm**.
- Quanteda Initiative CIC was founded to support the text analysts community
    
    ```{r echo=FALSE, out.height="80px", out.width="auto"}
    knitr::include_graphics("images/qi-logo.png")
    ```

## Materials to learn how to use Quanteda

- Quanteda Documentation: https://docs.quanteda.io
- Quanteda Tutorials: https://tutorials.quanteda.io
    - Overview
    - Data import
    - Basic operations
    - Statistical analysis
    - Advanced operations
    - Scaling and classification
    
## Machine learning using Quanteda

- Quanteda has original models for political scientists
    - `textmodel_wordscore()` for supervised document scaling
    - `textmodel_wordfish()` for unsupervised document
    - `textmodel_affinity()` for supervised document scaling 
- We also have functions optimized for large textual data
    - `textmodel_nb()` for naive bayes classification
    - `textmodel_ca()` for correspondence analysis
    - `textmodel_lsa()` for latent semantic analysis 
- Other packages works well with Quanteda
    - **topicmodels** or **LDA** for topic classification
    - **LSS** for semi-supervised document scaling
    
# Examples

## Preperation

We use movie review corpus (n=2000) to understand how to use machine learning models. We create a document-feature matrix from sentences only for **LSS**.

```{r}
# devtools::install_github("quanteda/quanteda.corpora")
require(quanteda.corpora)
require(quanteda)

corp <- data_corpus_movies
docvars(corp, "manual") <- factor(docvars(corp, "Sentiment"), c("neg", "pos"))

corp_sent <- corpus_reshape(corp)
mt_sent <- dfm(corp_sent, remove_punct = TRUE) %>% 
           dfm_trim(min_termfreq = 5) %>% 
           dfm_remove(stopwords("en"), min_nchar = 2)
mt <- dfm_group(mt_sent, "id2")
```
---
```{r}
data <- data.frame(manual = docvars(mt, "manual"))
```

## Feature selection

You can chooose features to be included in the models manually or automatically. The simplest way is to choose the most frequent ones after removing function words (stopwords).

```{r}
feat <- names(topfeatures(mt, 1000))
```

## Separate trainig and test sets

Performance of machine learning models have to be trained and tested on different dataset. This is called "out-of-sample" or "holdout" test.

```{r}
i <- seq(ndoc(mt)) 
l <- i %in% sample(i, 1500) 
mt_train <- mt[l,] 
mt_test <- mt[!l,]
```

## Measure of accuracy

- *Precision* and *recall* are the standard measures of accuracy in classification
    - *precision* measures percentage of true class in predicted class
        - Checks if **only** the relevant items are retrieved
    - *recall* measures percentage of predicted class in true class
        - Checks if **all** the relevant items are retrieved

```{r}
accuracy <- function (x) {
    list(neg_recall =  x[1,1] / sum(x[1,]),
         neg_precision = x[1,1] / sum(x[,1]),
         pos_recall = x[2,2] / sum(x[2,]),
         pos_precision = x[2,2] / sum(x[,2])
    )
}
```

## Naive Bayes 

```{r}
nb <- dfm_select(mt_train, feat) %>% 
    textmodel_nb(docvars(mt_train, "manual"))

data$nb <- NA
#data$nb[!l] <- predict(nb, newdata = mt_test) # should like this
data$nb[!l] <- predict(nb, newdata = dfm_select(mt_test, mt_train))$nb.predicted # should like this

tb_nb <- table(data$manual, data$nb, dnn = c("manual", "nb"))
tb_nb
mosaicplot(tb_nb)
accuracy(tb_nb)
```

